<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link data-n-head="1" rel="icon" type="image/x-icon" href="./static/favicon.ico">
        <title>Cash App Game Client</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
    <div id="screenspace" class="cashapp">
        <div id="staticHolder">
            <img src="./static/static.png" id='staticimg'>
        </div>
        <div id="loading">
            <img src="./static/Spinner4.gif" id="spinner">
        </div>
        <div id="boxGame">
            <div id="timerHolder">
                <p id="timerText" class="cashapp">_ACT_FAST</p>
                <p id="timer" class="cashapp">:30</p>
            </div>
            <div id='commandHolder'>
                <p id="commandText" class="cashapp">_CHAT_COMMANDS</p>
                <hr/ class="green cashapp">
                <p class="command cashapp" >UP</p>
                <div class="commandBar"><div id="upCommandBar" class="innerCommandBar cashapp" style="width: 10%;"></div></div>
                <hr/ class="green cashapp">
                <p class="command cashapp">DOWN</p>
                <div  class="commandBar"><div id="downCommandBar" class="innerCommandBar cashapp" style="width: 10%;"></div></div>
                <hr/ class="green cashapp">
                <p class="command cashapp">LEFT</p>
                <div class="commandBar"><div id="leftCommandBar" class="innerCommandBar cashapp" style="width: 10%;"></div></div>
                <hr/ class="green cashapp">
                <p class="command cashapp">RIGHT</p>
                <div class="commandBar"><div id="rightCommandBar" class="innerCommandBar cashapp" style="width: 10%;"></div></div>
                <hr/ class="green cashapp">
            </div>
            <div id='gridHolder'>
                <div id="grid">
                    <div id='box1' class="box flip-card">
                        <div id='box-inner1' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText1'>1</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue1">$100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box2' class="box flip-card">
                        <div id='box-inner2' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText2'>2</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue2">$200</p>
                            </div>
                        </div>
                    </div>
                    <div id='box3' class="box flip-card">
                        <div id='box-inner3' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText3'>3</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue3">$300</p>
                            </div>
                        </div>
                    </div>
                    <div id='box4' class="box flip-card">
                        <div id='box-inner4' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText4'>4</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue4">$400</p>
                            </div>
                        </div>
                    </div>
                    <div id='box5' class="box flip-card">
                        <div id='box-inner5' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText5'>5</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue5">$500</p>
                            </div>
                        </div>
                    </div>
                    <div id='box6' class="box flip-card">
                        <div id='box-inner6' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText6'>6</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue6">$600</p>
                            </div>
                        </div>
                    </div>
                    <div id='box7' class="box flip-card">
                        <div id='box-inner7' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText7'>7</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue7">$700</p>
                            </div>
                        </div>
                    </div>
                    <div id='box8' class="box flip-card">
                        <div id='box-inner8' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText8'>8</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue8">$800</p>
                            </div>
                        </div>
                    </div>
                    <div id='box9' class="box flip-card">
                        <div id='box-inner9' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText9'>9</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue9">$900</p>
                            </div>
                        </div>
                    </div>
                    <div id='box10' class="box flip-card">
                        <div id='box-inner10' class="flip-inner cashapp">
                            <div class="flip-front">
                                <!-- <p id='boxText10'>.</p> -->
                                <img src="./static/caticon.png" id="catIcon">
                            </div>
                            <div class="flip-back">
                                <p id="boxValue10">$1000</p>
                            </div>
                        </div>
                    </div>
                    <div id='box11' class="box flip-card">
                        <div id='box-inner11' class="flip-inner cashapp">
                            <div class="flip-front">
                                <p id='boxText11'>0</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue11">$1100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box12' class="box flip-card">
                        <div id='box-inner12' class="flip-inner cashapp">
                            <div class="flip-front">
                                <!-- <p id='boxText12'> < </p> -->
                                <img src="./static/fishbone.png" id="fishIcon">
                            </div>
                            <div class="flip-back">
                                <p id="boxValue12">$1200</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chatGame">
            <div id="royaleHolder" class="cashapp">
                <div id="wordHolder">
                </div>
            </div>
            <div id="eliminationHolder">
                <h1>Eliminations Leader</h1>
                <h1 id="eliminations"></h1>
            </div>
            <div id="uiHolder">
                <div>
                    <p>OnSreen:<span  id="onscreen">0</span></p>
                </div>
                <div>
                    <p>OffScreen:<span id="offscreen">0</span></p>
                </div>
                <div>
                    <p>Total:<span id="total">0</span></p>
                </div>
            </div>
        </div>
        <div id="startScene">
            <div id="startText">
                <h1>CASH APP ROYALE</h1>
                <h1 id='startMidText'>WIll BEGIN</h1>
                <h1 id="startCountdown">SOON</h1>
            </div>
        </div>
        <div id="intermissionScene">
            <div id="intermissionText">
                <h1>CASH APP ROYALE<br/>WILL BEGIN IN</h1>
                <h1 id="royaleCountdown">SOON</h1>
            </div>
        </div>
        <div id="newRoundScene">
            <div id="newRoundText">
                <h1><span id="winnerName"></span><br/> JUST WON <span id="prize"></span></h1>
                <h1 id="newRoundText2">NEXT ROUND WILL BEGIN IN</h1>
                <h1 id="roundCountdown">SOON</h1>
            </div>
        </div>
        <div id="textHolder">
            <div id="prizeHolder">
                <h1>Prize Pool: <span id="prizeAmount">0</span></h1>
                <h1>Prizes Earned: <span id="prizeEarned">0</span></h1>
                <h1 id="min">Min: </h1>
                <h1 id="max">Max: </h1>
                <h1 id="avg">Avg: </h1>
            </div>
            <div id="roundHolder">
                <h1 id="currentRound">Round: 1</h1>
            </div>
            <div id="winnerHolder">
            </div>
        </div>
        <div id="catHolder">
            <div id='cat1'>
                <img src="./static/cat1.png" alt="" id="catimg1">
            </div>
            <div id='cat3'>
                <img src="./static/cat3.png" alt="" id="catimg3" class="rotate">
            </div>
        </div>
    </div>
    <!-- <script src="main.js"></script> -->
    <script src="tmi.min.js"></script>
	<script src="helper.js"></script>
    <script>
        /* Twitch chatbot script */
        const commandArray = ['up', 'down', 'left', 'right'];
        const client = new tmi.Client(opts);
        let tmiConnected = false
        var mainAudio = new Audio("./static/soundFX/main.wav")
        mainAudio.loop = true
        var catAudio = new Audio("./static/soundFX/cat.wav")
        catAudio.loop = true
        var upAudio = new Audio("./static/soundFX/Move_Up.wav")
        var downAudio = new Audio("./static/soundFX/Move_Down.wav")
        var leftAudio = new Audio("./static/soundFX/Move_Left.wav")
        var rightAudio = new Audio("./static/soundFX/Move_Right.wav")
        var catUpAudio = new Audio("./static/soundFX/cat_up.wav")
        var catDownAudio = new Audio("./static/soundFX/cat_down.wav")
        var catLeftAudio = new Audio("./static/soundFX/cat_left.wav")
        var catRightAudio = new Audio("./static/soundFX/cat_right.wav")
        let directionAudio = {
            up: upAudio,
            down: downAudio,
            left: leftAudio,
            right: rightAudio,
        }
        let catDirectionAudio = {
            up: catUpAudio,
            down: catDownAudio,
            left: catLeftAudio,
            right: catRightAudio,
        }
        var minAudio = new Audio("./static/soundFX/small_value_prize.wav")
        var medAudio = new Audio("./static/soundFX/medium_value_prize.wav")
        var maxAudio = new Audio("./static/soundFX/high_value_prize.wav")
        var catPrizeAudio = new Audio("./static/soundFX/cat_button.wav")
        var fishPrizeAudio = new Audio("./static/soundFX/bones_button.wav")
        var prizeAudio = [minAudio, medAudio, maxAudio, catPrizeAudio, fishPrizeAudio]
        var winnerAudio1 = new Audio("./static/soundFX/win_1.wav")
        var winnerAudio2 = new Audio("./static/soundFX/win_2.wav")
        var winnerAudio3 = new Audio("./static/soundFX/win_3.wav")
        var winnerAudio4 = new Audio("./static/soundFX/win_4.wav")
        var winnerAudio5 = new Audio("./static/soundFX/win_5.wav")
        var winnerAudios = [
            winnerAudio1,
            winnerAudio2,
            winnerAudio3,
            winnerAudio4,
            winnerAudio5
        ]
        var countdownAudio = new Audio("./static/soundFX/in_between_last_number.wav")
        var tickAudio = new Audio("./static/soundFX/in_between_counter_numbers.wav")
        var eliminateAudio = new Audio("./static/soundFX/eliminate_player.wav")
        client.on('message', onMessageHandler);
        client.on('connected', onConnectedHandler);
        client.on('disconnected', onDisonnectedHandler);
        // client.connect();
        function onMessageHandler (target, context, msg, self) {
            let message = msg.trim();
            console.log(message)
            if(!(settings.chatGame)){
                message = message.toLowerCase()
                if(message.includes('up')){
                    votes['up'] += 1;
                    voteCount += 1;
                }else if(message.includes('down')){
                    votes['down'] += 1;
                    voteCount += 1;
                }else if(message.includes('right')){
                    votes['right'] += 1;
                    voteCount += 1;
                }else if(message.includes('left')){
                    votes['left'] += 1;
                    voteCount += 1;
                }
            }else{
                let wordNumber = message.split(' ').length
                if(wordNumber == 1){
                    message = message.toLocaleLowerCase()
                    if(renderList.hasOwnProperty(message)){
                        removeWord(message)
                        if(eliminations.hasOwnProperty(context['display-name'])){
                            eliminations[context['display-name']] = eliminations[context['display-name']] + 1
                        }else{
                            eliminations[context['display-name']] = 1
                        }
                        leader = Object.entries(eliminations).sort(([,a],[,b]) => b-a).slice(0,1)[0]
                        document.getElementById("eliminations").innerText = leader[0] + " - " + leader[1]
                    }
                }
            }
        }
        function onConnectedHandler (addr, port) {
            console.log(`* Connected to ${addr}:${port}`);
            tmiConnected = true
        }
        function onDisonnectedHandler () {
            console.log(`* Disconnected from twitch TMI`);
            tmiConnected = false
        }
        /* variables script */
        var votes = {
            up:0,
            down:0,
            right:0,
            left:0
        };
        let domEntered = false
        document.addEventListener("click", ()=>{
            if(!domEntered){
                startAudio()
                domEntered = true
            }
        });

        let catApp = false;
        let catCheck = false
        let currentCountdown = 10;
        let currentRound = 0;
        let earnedPrizes = 0;
        let currentPrize = 0;
        let override = [];
        let winners = [];
        var voteCount = 0;
        let ws = new WebSocket("wss://lhek8s2pxc.execute-api.us-east-2.amazonaws.com/dev?app=game");
        var settings = {
            chatGame: false,
            chaos:false,
            interval:5,
            timer:30,
            on: true,
            activeThreshold: 1,
            maxPlayers: 1000,
            refill: 280,
            expectedRounds: 30,
            prizePool: 5000,
            countdown: 5
        }
        let selected = 5
        /* Gridgame script */
        reset();
        function randomVotes(){
            for(let key in votes){
                votes[key] = getRandomIntInclusive(1,100)
            }
        }
        function voteLeft(){
            for(let key in votes){
                votes[key] = getRandomIntInclusive(1,100)
            }
            votes['left'] = 101
        }
        function voteDown(){
            for(let key in votes){
                votes[key] = getRandomIntInclusive(1,100)
            }
            votes['down'] = 101
        }
        async function countDown(element){
            currentCountdown = settings.countdown
            for(currentCountdown; currentCountdown > 0; currentCountdown--){
                element.innerText = currentCountdown
                tickAudio.play()
                await sleep(980)
            }
            countdownAudio.play()
            return;
        }
        function setIntermission(){
            document.getElementById('royaleCountdown').innerText = settings.countdown
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'none'
            document.getElementById('intermissionScene').style.display = 'block'
        }
        function setNewRoundScene(winner, amount){
            document.getElementById('winnerName').innerText = winner
            document.getElementById('prize').innerText = '$' + amount
            document.getElementById('startScene').style.display = 'none'
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'none'
            document.getElementById('newRoundScene').style.display = 'block'
        }
        function setScene(check){
            console.log("Setting Scene: ", check)
            if(check){
                document.getElementById('startScene').style.display = 'none'
                document.getElementById('chatGame').style.display = 'block'
                document.getElementById('boxGame').style.display = 'none'
                document.getElementById('loading').style.display = 'none'
                document.getElementById('intermissionScene').style.display = 'none'
                document.getElementById('newRoundScene').style.display = 'none'
            }else{
                document.getElementById('startScene').style.display = 'none'
                document.getElementById('chatGame').style.display = 'none'
                document.getElementById('boxGame').style.display = 'block'
                document.getElementById('loading').style.display = 'none'
                document.getElementById('intermissionScene').style.display = 'none'
                document.getElementById('newRoundScene').style.display = 'none'
            }
        }
        function loading(){
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'block'
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        function shuffle(arr) {
            var i = arr.length, j, temp;
            while(--i > 0){
                j = Math.floor(Math.random()*(i+1));
                temp = arr[j];
                arr[j] = arr[i];
                arr[i] = temp;
            }
        }
        function runVote(){
            for(let i = 1; i < 13; i++){
                let target = 'box-inner' + i;
                let ele = document.getElementById(target)
                if(catCheck){
                    if(i == selected){
                        ele.style.color = '#644bee'
                        ele.style.borderColor = '#644bee'
                    }else{
                        ele.style.color = '#c4bec9'
                        ele.style.borderColor = '#c4bec9'
                    }
                }else{
                    if(i == selected){
                        ele.style.color = 'limegreen'
                        ele.style.borderColor = 'limegreen'
                    }else{
                        ele.style.color = 'white'
                        ele.style.borderColor = 'white'
                    }
                }
            }
            if(selected == 10){
                if(catCheck){
                    document.getElementById('catIcon').src  = './static/caticonBlue.png'
                }else{
                    document.getElementById('catIcon').src  = './static/caticonGreen.png'
                }
            }else{
                if(catCheck){
                    document.getElementById('catIcon').src  = './static/caticonGray.png'
                }else{
                    document.getElementById('catIcon').src  = './static/caticon.png'
                }
            }
            if(selected == 12){
                if(catCheck){
                    document.getElementById('fishIcon').src  = './static/fishboneBlue.png'
                }else{
                    document.getElementById('fishIcon').src  = './static/fishboneGreen.png'
                }
            }else{
                if(catCheck){
                    document.getElementById('fishIcon').src  = './static/fishboneGray.png'
                }else{
                    document.getElementById('fishIcon').src  = './static/fishbone.png'
                }
            }
        }
        function reveal(){
            for(let i = 1; i < 13; i++){
                let target = 'box' + i;
                let ele = document.getElementById(target)
                ele.classList.add('show-card')
            }
        }
        const average = (array) => array.reduce((a, b) => a + b) / array.length;
        let globalmin;
        let globalmax;
        function setup(){
            let prizes = []
            if(override.length == 0){
                let max = Math.floor((settings.prizePool-earnedPrizes)/(settings.expectedRounds-currentRound)/5)*5;
                let min = Math.floor((0.2 + currentRound * (0.30/settings.expectedRounds))*max/5)*5
                globalmax = max
                globalmin = min
                prizes = [max,min,min,min]
                for(let i = 0; i<6; i++){
                    prizes.push(Math.floor(getRandomIntInclusive(min+5,max-5)/5)*5)
                }
                console.log("prizes:", prizes)
                document.getElementById('min').innerText = 'Min: ' + min
                document.getElementById('max').innerText = 'Max: ' + max
                document.getElementById('avg').innerText = 'Avg: ' + average(prizes)
                shuffle(prizes)
                console.log("Suffled prizes:", prizes)
                prizes[10] = prizes[9]
                prizes[11] = '0'
                prizes[9] = '0'
                console.log("Final prizes:", prizes)
            }else{
                prizes = override;
            }
            for(let i = 1; i < 13; i++){
                let target = 'boxValue' + i;
                let ele = document.getElementById(target)
                ele.innerText = '$' + prizes[i-1]
            }
        }
        async function simulateRoyale(){
            while(total > 1){
                let keys = Object.keys(renderList)
                let rand = getRandomIntInclusive(0,keys.length-1)
                removeWord(renderList[keys[rand]])
                await sleep(50)
            }
        }
        async function reset(){
            selected = 5;
            for(let i = 1; i < 13; i++){
                let target = 'box' + i;
                let ele = document.getElementById(target)
                ele.classList.remove('show-card')
            }
            await sleep(600)
            runVote()
            setup()
            let timer = document.getElementById('timer')
            timer.innerText = ':' + settings.timer
            let up = document.getElementById('upCommandBar')
            let down = document.getElementById('downCommandBar')
            let left = document.getElementById('leftCommandBar')
            let right = document.getElementById('rightCommandBar')
            let elements = [up,down,left,right]
            for(let i = 0; i<=3;i++){
                elements[i].style.background = 'white'
                elements[i].style.width = '10%'
            }
        }
        function barAnimate(winner, votes){
            let up = document.getElementById('upCommandBar')
            let down = document.getElementById('downCommandBar')
            let left = document.getElementById('leftCommandBar')
            let right = document.getElementById('rightCommandBar')
            let elements = [up,down,left,right]
            for(let i = 0; i<=3;i++){
                elements[i].style.background = 'white'
            }
            let widths = [up.style.width,down.style.width,left.style.width,right.style.width]
            let ends = [(votes.up/votes[winner])*100, (votes.down/votes[winner])*100, (votes.left/votes[winner])*100,(votes.right/votes[winner])*100]
            let differential = [ends[0]-parseFloat(widths[0]),ends[1]-parseFloat(widths[1]),ends[2]-parseFloat(widths[2]),ends[3]-parseFloat(widths[3])]
            let counter = 0
            let myInterval = setInterval(function(){
                for(let i = 0; i<=3;i++){
                    let start = parseFloat(elements[i].style.width)
                    let end = (start + (differential[i]/50))+'%'
                    elements[i].style.width = end
                }
                counter++
                // console.log(counter)
                if(counter>=50){
                    // console.log("clearing")
                    clearInterval(myInterval)
                    let target = winner + 'CommandBar'
                    document.getElementById(target).style.background = 'limegreen'
                    if(catCheck){
                        document.getElementById(target).style.background = '#644bee'
                    }
                }
            },20)
        }
        function barControl(winner, votes){
            barAnimate(winner,votes)
            // let max = votes[winner]
            // console.log(votes.up + "<>" + max)
            // console.log("winner: " + (votes.up/max)*100 + '%')
            // document.getElementById('upCommandBar').style.width = (votes.up/votes[winner])*100 + '%'
            // document.getElementById('downCommandBar').style.width = (votes.down/votes[winner])*100 + '%'
            // document.getElementById('leftCommandBar').style.width = (votes.left/votes[winner])*100 + '%'
            // document.getElementById('rightCommandBar').style.width = (votes.right/votes[winner])*100 + '%'
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function gridLogic(direction){
            let target = 'box-inner' + selected;
            if(direction == 'right'){
                if(selected%3 == 0){
                    selected = selected - 2;
                    runVote()
                }else{
                    selected = selected + 1;
                    runVote()
                }
            }else if(direction == 'left'){
                if((selected-1)%3 == 0){
                    selected = selected + 2;
                    runVote()
                }else{
                    selected = selected - 1;
                    runVote()
                }
            }else if(direction == 'up'){
                if(selected < 4){
                    selected = selected + 9;
                    runVote()
                }else{
                    selected = selected - 3;
                    runVote()
                }
            }else if(direction == 'down'){
                if(selected > 9){
                    selected = selected - 9;
                    runVote()
                }else{
                    selected = selected + 3;
                    runVote()
                }
            }
        }
        function parseCommand(){
            if(settings.chaos){
                let odds = getRandomIntInclusive(1,voteCount)
                odds = odds - votes.up
                if(odds >= 0){
                    return 'up'
                }
                odds = odds - votes.down
                if(odds >= 0){
                    return 'down'
                }
                odds = odds - votes.left
                if(odds >= 0){
                    return 'left'
                }
                return 'right'
            } else {
                let max = Math.max(votes.up,votes.down,votes.right,votes.left)
                let winner = Object.keys(votes).find(key => votes[key] === max)
                return winner
            }
        }
        function startCatApp(){
            catApp = false
            const collection = document.getElementsByClassName("cashapp");
            for(let item of collection){
                item.classList.add('catapp')
            }
            for(let i = 1; i < 13; i++){
                let target = 'box-inner' + i;
                let ele = document.getElementById(target)
                if(i == selected){
                    ele.style.color = '#644bee'
                    ele.style.borderColor = '#644bee'
                }else{
                    ele.style.color = '#7c7b80'
                    ele.style.borderColor = '#c4bec9'
                }
            }
            document.getElementById('catIcon').src = './static/caticonGray.png'
            document.getElementById('fishIcon').src = './static/fishboneGray.png'
            document.getElementById('catHolder').style.display = 'block'
            catAnimate()
            startCatAudio()
            startRound()
        }
        function stopCatApp(){
            const collection = document.getElementsByClassName("cashapp");
            for(let item of collection){
                item.classList.remove('catapp')
            }
            for(let i = 1; i < 13; i++){
                let target = 'box-inner' + i;
                let ele = document.getElementById(target)
                if(i == selected){
                    ele.style.color = 'limegreen'
                    ele.style.borderColor = 'limegreen'
                }else{
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                }
            }
            document.getElementById('catIcon').src = './static/caticon.png'
            document.getElementById('fishIcon').src = './static/fishbone.png'
            document.getElementById('catHolder').style.display = 'none'
            startAudio()
        }
        async function startRound(){
            currentPrize = 0
            currentRound++
            document.getElementById('currentRound').innerText = 'Round: ' + currentRound + '/' + settings.expectedRounds
            client.connect();
            votes = {
                up:0,
                down:0,
                right:0,
                left:0
            };
            voteCount = 0;
            let target = document.getElementById('timer')
            // let start = new Date().getTime();
            for(let i = settings.timer; i>=0; i--){
                // console.log(new Date().getTime() - start)
                target.innerText = ':' + i
                if((i!=settings.timer) && (i%settings.interval == 0)){
                    let winner = parseCommand()
                    console.log("Votes:", votes)
                    console.log("Winner:", winner)
                    if(catCheck){
                        catDirectionAudio[winner].play()
                    }else{
                        directionAudio[winner].play()
                    }
                    gridLogic(winner)
                    barControl(winner, votes)
                    votes = {
                        up:0,
                        down:0,
                        right:0,
                        left:0
                    }
                }
                await sleep(970);

            }
            document.getElementById('box' + selected).classList.add('show-card')
            let box = 'boxValue' + selected
            let winning = document.getElementById(box).innerText
            winning = winning.substring(1)
            if(winning == globalmin){
                minAudio.play()
            }else if(winning == globalmax){
                maxAudio.play()
            }else if(selected == 10){
                console.log('cat royale')
                catPrizeAudio.play()
                catApp = true
                catCheck = true
                winning = 0
            }else if(selected == 12){
                console.log('bad')
                fishPrizeAudio.play()
                winning = 0
            }else{
                medAudio.play()
            }
            for(let i = 13; i>=0; i--){
                target.style.visibility = (target.style.visibility == 'hidden' ? '' : 'hidden');
                await sleep(150);
            }
            reveal()
            client.disconnect();
            winning = parseInt(winning)
            earnedPrizes += winning
            currentPrize = winning
            document.getElementById("prizeEarned").innerText = '$' + earnedPrizes
            if(catApp){
                await sleep(2000);
                await reset()
                startCatApp();
            }else {
                await sleep(2000);            
                document.getElementById('catHolder').style.display = 'none'
                setIntermission()
                let target = document.getElementById('royaleCountdown')
                await countDown(target)
                ws.send(JSON.stringify({ action: 'message', header: 'startRoyale' }));
                await reset()
                settings.chatGame = true
                setScene(settings.chatGame)
            }
        }
        /* Chat game script */
        let onscreen, offscreen, total;
        let myInterval;
        let leader;
        // shuffle(words)
        let words = []
        let renderList = {}
        let eliminations = {}
        console.log("JS LOADED")
        function startRoyale(players){
            document.getElementById("eliminations").innerText = ""
            words = []
            renderList = {}
            eliminations = {}
            console.log("Start Royale")
            shuffle(players)
            let playnum = Math.min(players.length, settings.maxPlayers)
            for(let i = 0; i<playnum; i++){
                words.push(players[i].twitchname.toLowerCase())
            }
            while(Object.keys(renderList).length< 300 && words.length){
                let item = words.pop()
                renderList[item]=item;
            }
            onscreen = Object.keys(renderList).length
            offscreen = words.length
            display()
            client.connect();
            // console.log(words)
        }
        function shuffle(arr){
            let length = arr.length, rand, temp
            while(--length>0){
                rand = Math.floor(Math.random() * (length+1));
                temp = arr[rand];
                arr[rand] = arr[length];
                arr[length] = temp;
            }
        }
        // loadRender()
        function display(){
            console.log("display")
            total = onscreen+offscreen
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            document.getElementById("offscreen").innerText = offscreen;
            document.getElementById("wordHolder").remove();
            let holder = document.createElement("div")
            holder.setAttribute("id", "wordHolder")
            document.getElementById("royaleHolder").append(holder)
            let i = 0;
            for(let item in renderList){
                // console.log(item)
                let div = document.createElement("div")
                div.setAttribute("class","word")
                // let name = "item"+i
                div.setAttribute("id",item.toLocaleLowerCase())
                let p = document.createElement("p")
                p.setAttribute("class","wordText")
                p.innerText = item
                div.append(p)
                document.getElementById("wordHolder").append(div)
                i++
            }
        }
        function showEliminations(){
            console.log(eliminations)
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        async function removeWord(name){
            console.log("remove word:", name)
            var eliminateAudio = new Audio("./static/soundFX/eliminate_player.wav")
            eliminateAudio.play()
            delete renderList[name]
            total--
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            if(Object.keys(words).length){
                let item = words.pop()
                renderList[item] = item
                document.getElementById(name).children[0].innerText = item
                document.getElementById(name).id = item
                offscreen--
                document.getElementById("offscreen").innerText = offscreen;
            }else{
                document.getElementById(name).style.visibility = 'hidden'
                onscreen--
                document.getElementById("onscreen").innerText = onscreen;
            }
            if(onscreen<2){
                if(catCheck){
                    catCheck = false
                    stopCatApp()
                }
                winnerAudios[getRandomIntInclusive(0,4)].play()
                client.disconnect();
                console.log("Winner: " + renderList[Object.keys(renderList)[0]])
                let newItem = {
                    name: renderList[Object.keys(renderList)[0]],
                    round: currentRound,
                    amount: currentPrize
                }
                winners.push(newItem)
                let para = document.createElement("p");
                para.innerText = newItem.name + ' has won: $' +   newItem.amount
                document.getElementById("winnerHolder").appendChild(para)
                setNewRoundScene(newItem.name, newItem.amount)
                if(currentRound < settings.expectedRounds){
                    let target = document.getElementById("roundCountdown")
                    await countDown(target)
                    settings.chatGame = false
                    setScene(settings.chatGame)
                    startRound()
                }
            }
        }
        // display()
        function runGame(){
            myInterval = setInterval(randRemove, 50);
        }
        function newGameData(data){
            console.log('Game Data Received')
            currentRound = 0;
            earnedPrizes = 0;
            for(let item of data){
                currentRound++
                console.log(item)
                winners.push(item)
                earnedPrizes += item.amount
            }
            setup()
            document.getElementById('currentRound').innerText = 'Round: ' + currentRound + '/' + settings.expectedRounds
            document.getElementById('prizeEarned').innerText = '$' + earnedPrizes
        }
        function startAudio(){
            catAudio.pause()
            mainAudio.play()
        }
        function startCatAudio(){
            mainAudio.pause()
            catAudio.play()
        }
        function pauseAudio(){
            mainAudio.pause()
            catAudio.pause()
        }
        function audioControl(data){
            console.log("AUDIO DATA")
            console.log(data)
            mainAudio.volume = parseInt(data.mainBG) * 0.01
            catAudio.volume = parseInt(data.catBG) * 0.01
            for(let sound in directionAudio){
                directionAudio[sound].volume = parseInt(data.directions) * 0.01
            }
            for(let sound in catDirectionAudio){
                catDirectionAudio[sound].volume = parseInt(data.catDirections) * 0.01
            }
            for(let sound of prizeAudio){
                sound.volume = parseInt(data.prize) * 0.01
            }
            for(let sound of winnerAudios){
                sound.volume = parseInt(data.winner) * 0.01
            }
            eliminateAudio.volume = parseInt(data.elimination) * 0.01
            countdownAudio.volume = parseInt(data.countdown) * 0.01
        }
        /* Websocket script */
        let myCatInterval;
        let cattoggle= false
        function catAnimate(){
            myCatInterval = setInterval(function () {
                let cat = document.getElementById('catimg1')
                if(cattoggle){
                    cat.src = './static/cat1.png'
                }else{
                    cat.src = './static/cat2.png'
                }
                cattoggle = !cattoggle
            }, 700);
        }
        function clearCat(){
            clearInterval(myCatInterval)
        }
        function pingServer(){
            console.log("pinging server")
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
        }
        ws.onopen = function() {
            console.log('Websocket connected')
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
            ws.send(JSON.stringify({ action: 'message', header: 'getGameData' }));
            ws.send(JSON.stringify({ action: 'message', header: 'getAudio' }));
        }
        ws.onmessage = async function (evt) { 
            var received = evt.data;
            let parsed = JSON.parse(received)
            console.log(parsed)
            if(parsed.header == 'startGrid'){
                document.getElementById('startMidText').innerHTML = 'WILL BEGIN IN'
                let target = document.getElementById('startCountdown')
                await countDown(target)
                setScene(settings.chatGame)
                startRound();
            }else if(parsed.header == 'startRoyale'){
                startRoyale(parsed.data);
            }else if(parsed.header == 'resetGrid'){
                reset();
            }else if(parsed.header == 'newGameData'){
                newGameData(parsed.data);
            }else if(parsed.header == 'gameSettings'){
                let data = parsed.data
                console.log(data)
                settings.chatGame = data.chatScene
                settings.timer = data.gridDuration
                settings.interval = data.gridInterval
                settings.chaos = data.chaosMode
                settings.maxPlayers = data.maxPlayers
                settings.refill = data.refill
                settings.expectedRounds = data.expectedRounds
                settings.prizePool = data.prizePool
                settings.countdown = data.countdown
                currentCountdown = data.countdown
                document.getElementById("prizeAmount").innerText = '$' + data.prizePool
                reset()
                document.getElementById('loading').style.display = 'none'
                document.getElementById('startScene').style.display = 'block'
                // setScene(settings.chatGame)
            }else if(parsed.header == 'vote'){
                let command = parsed.winner
                gridLogic(command)
                barControl(command, parsed.votes)
            }else if(parsed.header == 'audioSettings'){
                let resAudio = parsed.data
                audioControl(resAudio)
            }
            console.log("received data over websocket")
            console.log(received)
        };
        ws.onclose = function() { 
            console.log("websocket closed")
        };
    
    </script>
  </body>
</html>