<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link data-n-head="1" rel="icon" type="image/x-icon" href="./static/favicon.ico">
        <title>Cash App Game Client</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
    <div id="screenspace">
        <div id="staticHolder">
            <img src="./static/static.png" id='staticimg'>
        </div>
        <div id="loading">
            <img src="./static/Spinner4.gif" id="spinner">
        </div>
        <div id="boxGame">
            <div id="timerHolder">
                <p id="timerText">_ACT_FAST</p>
                <p id="timer">:30</p>
            </div>
            <div id='commandHolder'>
                <p id="commandText">_CHAT_COMMANDS</p>
                <hr/ class="green">
                <p class="command">UP</p>
                <div class="commandBar"><div id="upCommandBar" class="innerCommandBar" style="width: 10%;"></div></div>
                <hr/ class="green">
                <p class="command">DOWN</p>
                <div  class="commandBar"><div id="downCommandBar" class="innerCommandBar" style="width: 10%;"></div></div>
                <hr/ class="green">
                <p class="command">LEFT</p>
                <div class="commandBar"><div id="leftCommandBar" class="innerCommandBar" style="width: 10%;"></div></div>
                <hr/ class="green">
                <p class="command">RIGHT</p>
                <div class="commandBar"><div id="rightCommandBar" class="innerCommandBar" style="width: 10%;"></div></div>
                <hr/ class="green">
            </div>
            <div id='gridHolder'>
                <div id="grid">
                    <div id='box1' class="box flip-card">
                        <div id='box-inner1' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText1'>1</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue1">$100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box2' class="box flip-card">
                        <div id='box-inner2' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText2'>2</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue2">$200</p>
                            </div>
                        </div>
                    </div>
                    <div id='box3' class="box flip-card">
                        <div id='box-inner3' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText3'>3</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue3">$300</p>
                            </div>
                        </div>
                    </div>
                    <div id='box4' class="box flip-card">
                        <div id='box-inner4' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText4'>4</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue4">$400</p>
                            </div>
                        </div>
                    </div>
                    <div id='box5' class="box flip-card">
                        <div id='box-inner5' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText5'>5</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue5">$500</p>
                            </div>
                        </div>
                    </div>
                    <div id='box6' class="box flip-card">
                        <div id='box-inner6' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText6'>6</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue6">$600</p>
                            </div>
                        </div>
                    </div>
                    <div id='box7' class="box flip-card">
                        <div id='box-inner7' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText7'>7</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue7">$700</p>
                            </div>
                        </div>
                    </div>
                    <div id='box8' class="box flip-card">
                        <div id='box-inner8' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText8'>8</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue8">$800</p>
                            </div>
                        </div>
                    </div>
                    <div id='box9' class="box flip-card">
                        <div id='box-inner9' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText9'>9</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue9">$900</p>
                            </div>
                        </div>
                    </div>
                    <div id='box10' class="box flip-card">
                        <div id='box-inner10' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText10'>.</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue10">$1000</p>
                            </div>
                        </div>
                    </div>
                    <div id='box11' class="box flip-card">
                        <div id='box-inner11' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText11'>0</p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue11">$1100</p>
                            </div>
                        </div>
                    </div>
                    <div id='box12' class="box flip-card">
                        <div id='box-inner12' class=flip-inner>
                            <div class="flip-front">
                                <p id='boxText12'> < </p>
                            </div>
                            <div class="flip-back">
                                <p id="boxValue12">$1200</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="chatGame">
            <div id="royaleHolder">
                <div id="wordHolder">
                </div>
            </div>
            <div id="eliminationHolder">
                <h1>Eliminations Leader</h1>
                <h1 id="eliminations">Placeholder: 0</h1>
            </div>
            <div id="uiHolder">
                <div>
                    <p>OnSreen:<span  id="onscreen">0</span></p>
                </div>
                <div>
                    <p>OffScreen:<span id="offscreen">0</span></p>
                </div>
                <div>
                    <p>Total:<span id="total">0</span></p>
                </div>
            </div>
        </div>
    </div>
    <!-- <script src="main.js"></script> -->
    <script src="tmi.min.js"></script>
	<script src="helper.js"></script>
    <script>
        /* Twitch chatbot script */
        const commandArray = ['!up', '!down', '!left', '!right'];
        const client = new tmi.Client(opts);
        let tmiConnected = false
        client.on('message', onMessageHandler);
        client.on('connected', onConnectedHandler);
        client.on('disconnected', onDisonnectedHandler);
        // client.connect();
        function onMessageHandler (target, context, msg, self) {
            let message = msg.trim();
            console.log(message)
            if(!(settings.chatGame)){
                if(message.includes('!up')){
                    votes['up'] += 1;
                    voteCount += 1;
                }else if(message.includes('!down')){
                    votes['down'] += 1;
                    voteCount += 1;
                }else if(message.includes('!right')){
                    votes['right'] += 1;
                    voteCount += 1;
                }else if(message.includes('!left')){
                    votes['left'] += 1;
                    voteCount += 1;
                }
            }else{
                let wordNumber = message.split(' ').length
                if(wordNumber == 1){
                    message = message.toLocaleLowerCase()
                    if(renderList.hasOwnProperty(message)){
                        removeWord(message)
                        if(eliminations.hasOwnProperty(context['display-name'])){
                            eliminations[context['display-name']] = eliminations[context['display-name']] + 1
                        }else{
                            eliminations[context['display-name']] = 1
                        }
                        leader = Object.entries(eliminations).sort(([,a],[,b]) => b-a).slice(0,1)
                        document.getElementById("eliminations").innerText = leader[0] + " - " + leader[1]
                    }
                }
            }
        }
        function onConnectedHandler (addr, port) {
            console.log(`* Connected to ${addr}:${port}`);
            tmiConnected = true
        }
        function onDisonnectedHandler () {
            console.log(`* Disconnected from twitch TMI`);
            tmiConnected = false
        }
        /* variables script */
        var votes = {
            up:0,
            down:0,
            right:0,
            left:0
        };
        var voteCount = 0;
        let ws = new WebSocket("wss://lhek8s2pxc.execute-api.us-east-2.amazonaws.com/dev?app=game");
        var settings = {
            chatGame: false,
            chaos:false,
            interval:5,
            timer:30,
            on: true,
            activeThreshold: 1,
            maxPlayers: 1000,
            refill: 280
        }
        let selected = 5
        /* Gridgame script */
        reset();
        function setScene(check){
            console.log("Setting Scene: ", check)
            if(check){
                document.getElementById('chatGame').style.display = 'block'
                document.getElementById('boxGame').style.display = 'none'
                document.getElementById('loading').style.display = 'none'
            }else{
                document.getElementById('chatGame').style.display = 'none'
                document.getElementById('boxGame').style.display = 'block'
                document.getElementById('loading').style.display = 'none'
            }
        }
        function loading(){
            document.getElementById('chatGame').style.display = 'none'
            document.getElementById('boxGame').style.display = 'none'
            document.getElementById('loading').style.display = 'block'
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        function runVote(){
            for(let i = 1; i < 13; i++){
                let target = 'box-inner' + i;
                let ele = document.getElementById(target)
                if(i == selected){
                    ele.style.color = 'limegreen'
                    ele.style.borderColor = 'limegreen'
                }else{
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                }
            }
        }
        function reveal(){
            for(let i = 1; i < 13; i++){
                let target = 'box' + i;
                let ele = document.getElementById(target)
                ele.classList.add('show-card')
            }
        }
        function setup(){
            for(let i = 1; i < 13; i++){
                let target = 'boxValue' + i;
                let ele = document.getElementById(target)
                ele.innerText = '$' + getRandomIntInclusive(1,1000)
            }
        }
        function reset(){
            selected = 5;
            runVote()
            setup()
            for(let i = 1; i < 13; i++){
                let target = 'box' + i;
                let ele = document.getElementById(target)
                ele.classList.remove('show-card')
            }
            let timer = document.getElementById('timer')
            timer.innerText = ':' + settings.timer
            let up = document.getElementById('upCommandBar')
            let down = document.getElementById('downCommandBar')
            let left = document.getElementById('leftCommandBar')
            let right = document.getElementById('rightCommandBar')
            let elements = [up,down,left,right]
            for(let i = 0; i<=3;i++){
                elements[i].style.background = 'limegreen'
                elements[i].style.width = '10%'
            }
        }
        function barAnimate(winner, votes){
            let up = document.getElementById('upCommandBar')
            let down = document.getElementById('downCommandBar')
            let left = document.getElementById('leftCommandBar')
            let right = document.getElementById('rightCommandBar')
            let elements = [up,down,left,right]
            for(let i = 0; i<=3;i++){
                elements[i].style.background = 'limegreen'
            }
            let widths = [up.style.width,down.style.width,left.style.width,right.style.width]
            let ends = [(votes.up/votes[winner])*100, (votes.down/votes[winner])*100, (votes.left/votes[winner])*100,(votes.right/votes[winner])*100]
            let differential = [ends[0]-parseFloat(widths[0]),ends[1]-parseFloat(widths[1]),ends[2]-parseFloat(widths[2]),ends[3]-parseFloat(widths[3])]
            let counter = 0
            // for(let i = 0; i<=3;i++){
            //     let width = elements[i].style.width
            //     let start = parseFloat(width)
            //     console.log(differential[i])
            //     console.log(differential[i]/10)
            //     let end = (start + (differential[i]/10))+'%'
            //     console.log(end)
            //     elements[i].style.width = end
            // }
            let myInterval = setInterval(function(){
                for(let i = 0; i<=3;i++){
                    let start = parseFloat(elements[i].style.width)
                    let end = (start + (differential[i]/50))+'%'
                    elements[i].style.width = end
                }
                counter++
                // console.log(counter)
                if(counter>=50){
                    // console.log("clearing")
                    clearInterval(myInterval)
                    let target = winner + 'CommandBar'
                    document.getElementById(target).style.background = 'red'
                }
            },20)
        }
        function barControl(winner, votes){
            barAnimate(winner,votes)
            // let max = votes[winner]
            // console.log(votes.up + "<>" + max)
            // console.log("winner: " + (votes.up/max)*100 + '%')
            // document.getElementById('upCommandBar').style.width = (votes.up/votes[winner])*100 + '%'
            // document.getElementById('downCommandBar').style.width = (votes.down/votes[winner])*100 + '%'
            // document.getElementById('leftCommandBar').style.width = (votes.left/votes[winner])*100 + '%'
            // document.getElementById('rightCommandBar').style.width = (votes.right/votes[winner])*100 + '%'
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function gridLogic(direction){
            let target = 'box-inner' + selected;
            if(direction == 'right'){
                if(selected%3 == 0){
                    let ele = document.getElementById(target)
                    ele.style.background = 'limegreen'
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                    await sleep(200);
                    ele.style.color = 'limegreen'
                    ele.style.background = 'black'
                    ele.style.borderColor = 'limegreen'
                }else{
                    selected = selected + 1;
                    runVote()
                }
            }else if(direction == 'left'){
                if((selected-1)%3 == 0){
                    let ele = document.getElementById(target)
                    ele.style.background = 'limegreen'
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                    await sleep(200);
                    ele.style.color = 'limegreen'
                    ele.style.background = 'black'
                    ele.style.borderColor = 'limegreen'
                }else{
                    selected = selected - 1;
                    runVote()
                }
            }else if(direction == 'up'){
                if(selected < 4){
                    let ele = document.getElementById(target)
                    ele.style.background = 'limegreen'
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                    await sleep(200);
                    ele.style.color = 'limegreen'
                    ele.style.background = 'black'
                    ele.style.borderColor = 'limegreen'
                }else{
                    selected = selected - 3;
                    runVote()
                }
            }else if(direction == 'down'){
                if(selected > 9){
                    let ele = document.getElementById(target)
                    ele.style.background = 'limegreen'
                    ele.style.color = 'white'
                    ele.style.borderColor = 'white'
                    await sleep(200);
                    ele.style.color = 'limegreen'
                    ele.style.background = 'black'
                    ele.style.borderColor = 'limegreen'
                }else{
                    selected = selected + 3;
                    runVote()
                }
            }
        }
        function parseCommand(){
            if(settings.chaos){
                let odds = getRandomIntInclusive(1,voteCount)
                odds = odds - votes.up
                if(odds >= 0){
                    return 'up'
                }
                odds = odds - votes.down
                if(odds >= 0){
                    return 'down'
                }
                odds = odds - votes.left
                if(odds >= 0){
                    return 'left'
                }
                return 'right'
            } else {
                let max = Math.max(votes.up,votes.down,votes.right,votes.left)
                let winner = Object.keys(votes).find(key => votes[key] === max)
                return winner
            }
        }
        async function startRound(){
            client.connect();
            votes = {
                up:0,
                down:0,
                right:0,
                left:0
            };
            voteCount = 0;
            let target = document.getElementById('timer')
            // let start = new Date().getTime();
            for(let i = settings.timer; i>=0; i--){
                // console.log(new Date().getTime() - start)
                target.innerText = ':' + i
                if((i!=settings.timer) && (i%settings.interval == 0)){
                    let winner = parseCommand()
                    console.log("Votes:", votes)
                    console.log("Winner:", winner)
                    gridLogic(winner)
                    barControl(winner, votes)
                    votes = {
                        up:0,
                        down:0,
                        right:0,
                        left:0
                    }
                }
                await new Promise(r => setTimeout(r, 980));

            }
            document.getElementById('box' + selected).classList.add('show-card')
            for(let i = 13; i>=0; i--){
                target.style.visibility = (target.style.visibility == 'hidden' ? '' : 'hidden');
                await new Promise(r => setTimeout(r, 150));
            }
            reveal()
            client.disconnect();
        }
        /* Chat game script */
        let onscreen, offscreen, total;
        let myInterval;
        let leader;
        // shuffle(words)
        let words = []
        let renderList = {}
        let eliminations = {}
        console.log("JS LOADED")
        function startRoyale(players){
            words = []
            renderList = {}
            eliminations = {}
            console.log("Start Royale")
            let playnum = Math.min(players.length, settings.maxPlayers)
            for(let i = 0; i<playnum; i++){
                words.push(players[i].twitchname)
            }
            loadRender()
            display()
            client.connect();
            // console.log(words)
        }
        function loadRender(){
            while(Object.keys(renderList).length< 300 && words.length){
                let item = words.pop().toLocaleLowerCase()
                renderList[item]=item;
            }
            onscreen = Object.keys(renderList).length
            offscreen = words.length
            // renderList.push(words.pop())
        }
        function shuffle(arr){
            let length = arr.length, rand, temp
            while(--length>0){
                rand = Math.floor(Math.random() * (length+1));
                temp = arr[rand];
                arr[rand] = arr[length];
                arr[length] = temp;
            }
        }
        // loadRender()
        function display(){
            console.log("display")
            total = onscreen+offscreen
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            document.getElementById("offscreen").innerText = offscreen;
            document.getElementById("wordHolder").remove();
            let holder = document.createElement("div")
            holder.setAttribute("id", "wordHolder")
            document.getElementById("royaleHolder").append(holder)
            let i = 0;
            for(let item in renderList){
                // console.log(item)
                let div = document.createElement("div")
                div.setAttribute("class","word")
                // let name = "item"+i
                div.setAttribute("id",item.toLocaleLowerCase())
                let p = document.createElement("p")
                p.setAttribute("class","wordText")
                p.innerText = item
                div.append(p)
                document.getElementById("wordHolder").append(div)
                i++
            }
        }
        function showEliminations(){
            console.log(eliminations)
        }
        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
        }
        function removeWord(name){
            document.getElementById(name).style.visibility = "hidden"
            delete renderList[name]
            total--
            onscreen--
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            if(onscreen<=settings.refill && offscreen>0){
                loadRender()
                display()
            }
            if(onscreen<2){
                client.disconnect();
                console.log("Winner: " + renderList[Object.keys(renderList)[0]])
            }
        }
        function randRemove(){
            let items = Object.keys(renderList)
            let rand = getRandomIntInclusive(0,items.length-1)
            document.getElementById(items[rand]).style.visibility = "hidden"
            delete renderList[items[rand]]
            total--
            onscreen--
            document.getElementById("total").innerText = total;
            document.getElementById("onscreen").innerText = onscreen;
            if(onscreen<=250 && offscreen>0){
                loadRender()
                display()
            }
            if(onscreen<2){
                clearInterval(myInterval);
                console.log("Winner: " + renderList[Object.keys(renderList)[0]])
            }
            // console.log(items.length)
            // return(items-1)
        }
        // display()
        function runGame(){
            myInterval = setInterval(randRemove, 50);
        }
        /* Websocket script */
        function pingServer(){
            console.log("pinging server")
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
        }
        ws.onopen = function() {
            console.log('Websocket connected')
            ws.send(JSON.stringify({ action: 'message', header: 'gameSettings' }));
        }
        ws.onmessage = function (evt) { 
            var received = evt.data;
            let parsed = JSON.parse(received)
            console.log(parsed)
            if(parsed.header == 'startGrid'){
                startRound();
            }else if(parsed.header == 'startRoyale'){
                startRoyale(parsed.data);
            }else if(parsed.header == 'resetGrid'){
                reset();
            }else if(parsed.header == 'gameSettings'){
                let data = parsed.data
                console.log(data)
                settings.chatGame = data.chatScene
                settings.timer = data.gridDuration
                settings.interval = data.gridInterval
                settings.chaos = data.chaosMode
                settings.maxPlayers = data.maxPlayers
                settings.refill = data.refill
                reset()
                setScene(chatGame)
            }else if(parsed.header == 'vote'){
                let command = parsed.winner
                gridLogic(command)
                barControl(command, parsed.votes)
            }
            console.log("received data over websocket")
            console.log(received)
        };
        ws.onclose = function() { 
            console.log("websocket closed")
        };
    
    </script>
  </body>
</html>